<!-- Breadcrumb Navigation -->
<nav class="breadcrumb" aria-label="Breadcrumb">
  <a href="/">Home</a>
  <span class="breadcrumb-separator">/</span>
  <a href="/projects">Projects</a>
  <span class="breadcrumb-separator">/</span>
  <a href="/projects/<%= @project.id %>"><%= h(@project.name) %></a>
  <span class="breadcrumb-separator">/</span>
  <span class="breadcrumb-current"><%= h(@thread.title) %></span>
</nav>

<header class="project-hero" role="region" aria-label="Thread overview">
  <div class="project-hero-content">
    <div class="project-title-section">
      <h1 class="project-title"><%= h(@thread.title) %></h1>
      <p class="project-subtitle"><%= h(@thread.description.to_s) %></p>
      <div class="project-meta-info">
        <div class="meta-item">
          <span>In project </span>
          <a href="/projects/<%= @project.id %>" class="meta-link"><%= h(@project.name) %></a>
        </div>
        <div class="meta-item">
          <span>Started by </span>
          <a href="/profile/<%= @thread.user.id %>" class="meta-link"><%= h(@thread.user.username) %></a>
        </div>
        <div class="meta-item">
          <span><%= time_ago(@thread.created_at) %></span>
        </div>
        <% if @thread.locked %>
          <div class="meta-item">
            <span class="status-badge status-inactive">Locked</span>
          </div>
        <% end %>
      </div>
    </div>

    <div class="project-hero-actions" aria-hidden="false">
      <div class="action-group">
        <a href="/projects/<%= @project.id %>" class="btn btn-ghost">Back to Project</a>
        <% if current_user.admin? || current_user.id == @project.user_id %>
          <a href="/projects/<%= @project.id %>/threads/<%= @thread.id %>/edit" class="btn btn-primary">Edit Thread</a>
          <form action="/projects/<%= @project.id %>/threads/<%= @thread.id %>" method="POST" style="display:inline;" onsubmit="return confirm('Delete this thread and all its messages?');">
            <input type="hidden" name="_method" value="DELETE">
            <button type="submit" class="btn btn-danger">Delete Thread</button>
          </form>
        <% end %>
      </div>
    </div>
  </div>
</header>

<div class="content-card" id="messages">
  <div class="card-header-section">
    <h2 class="card-title">Messages</h2>
    <span class="card-badge"><%= @messages.size %> <%= @messages.size == 1 ? "message" : "messages" %></span>
  </div>

  <div class="card-content">
    <% if @messages.any? %>
      <% parents = @messages.select { |m| m.parent_message_id.nil? } %>
      <div class="comments-list" style="display:flex; flex-direction:column; gap:1rem;">
        <% parents.each do |message| %>
          <% replies = @messages.select { |m| m.parent_message_id == message.id } %>
          <div id="message-<%= message.id %>" class="comment-item" style="display:flex; gap:0.75rem; padding:1rem; background:var(--bg-secondary); border-radius:var(--radius-lg); border:1px solid var(--border); scroll-margin-top:100px;">
            <div class="avatar-sm" style="flex-shrink:0;">
              <%= h(message.user.username[0].upcase) %>
            </div>
            <div class="comment-content" style="flex:1; min-width:0;">
              <div class="comment-header" style="display:flex; justify-content:space-between; align-items:flex-start; margin-bottom:0.5rem;">
                <div>
                  <a href="/profile/<%= message.user.id %>" class="comment-author" style="font-weight:600; color:var(--text-primary); text-decoration:none;">
                    <%= h(message.user.username) %>
                  </a>
                  <span class="comment-time" style="color:var(--text-muted); font-size:0.8rem; margin-left:0.5rem;">
                    <%= time_ago(message.created_at) %>
                    <% if message.edited_at.present? %>
                      <span style="font-style:italic;">(edited)</span>
                    <% end %>
                  </span>
                </div>

                <div class="comment-actions" style="display:flex; gap:0.5rem;">
                  <%# Reply button (any associated user) %>
                  <% if current_user.can_manage?(@project) && !@thread.locked %>
                    <button type="button" class="btn btn-ghost btn-sm" title="Reply" onclick="replyToMessage(<%= message.id %>, '<%= h(message.user.username) %>')">
                      <i class="fa-solid fa-reply"></i>
                    </button>
                  <% end %>

                  <% if current_user.can_manage_message?(message) %>
                    <a href="/projects/<%= @project.id %>/threads/<%= @thread.id %>/messages/<%= message.id %>/edit" class="btn btn-ghost btn-sm" title="Edit message">
                      <i class="fa-solid fa-pen"></i>
                    </a>
                    <form action="/projects/<%= @project.id %>/threads/<%= @thread.id %>/messages/<%= message.id %>" method="POST" style="display:inline;" onsubmit="return confirm('Delete this message?');">
                      <input type="hidden" name="_method" value="DELETE">
                      <button type="submit" class="btn btn-ghost btn-sm" style="color:var(--danger);" title="Delete message">
                        <i class="fa-solid fa-trash"></i>
                      </button>
                    </form>
                  <% end %>
                </div>
              </div>

              <div class="comment-body" style="color:var(--text-secondary); line-height:1.6; word-wrap:break-word;">
                <%= simple_format(h(message.content)) %>
              </div>

              <% if replies.any? %>
                <div class="replies" style="margin-top:0.75rem; display:flex; flex-direction:column; gap:0.75rem; padding-left:1rem; border-left:2px solid var(--border);">
                  <% replies.each do |reply| %>
                    <div id="message-<%= reply.id %>" class="reply-item" style="display:flex; gap:0.75rem; padding:0.75rem; background:var(--bg-primary); border-radius:var(--radius-lg); border:1px solid var(--border);">
                      <div class="avatar-xs" style="flex-shrink:0; width:28px; height:28px; border-radius:999px; display:flex; align-items:center; justify-content:center; background:rgba(59,130,246,0.12); color:var(--primary-light); font-weight:700;">
                        <%= h(reply.user.username[0].upcase) %>
                      </div>
                      <div style="flex:1; min-width:0;">
                        <div style="display:flex; justify-content:space-between; gap:0.75rem; align-items:flex-start;">
                          <div>
                            <a href="/profile/<%= reply.user.id %>" style="font-weight:600; color:var(--text-primary); text-decoration:none;">
                              <%= h(reply.user.username) %>
                            </a>
                            <span style="color:var(--text-muted); font-size:0.8rem; margin-left:0.5rem;">
                              <%= time_ago(reply.created_at) %>
                              <% if reply.edited_at.present? %>
                                <span style="font-style:italic;">(edited)</span>
                              <% end %>
                            </span>
                          </div>

                          <div style="display:flex; gap:0.4rem;">
                            <% if current_user.can_manage?(@project) && !@thread.locked %>
                              <button type="button" class="btn btn-ghost btn-sm" title="Reply" onclick="replyToMessage(<%= reply.id %>, '<%= h(reply.user.username) %>', <%= message.id %>)">
                                <i class="fa-solid fa-reply"></i>
                              </button>
                            <% end %>

                            <% if current_user.id == reply.user_id %>
                            <a href="/projects/<%= @project.id %>/threads/<%= @thread.id %>/messages/<%= reply.id %>/edit" class="btn btn-ghost btn-sm" title="Edit reply">
                            <i class="fa-solid fa-pen"></i>
                            </a>
                            <% end %>
                            
                            <% if current_user.can_manage_message?(message) %>
                            <form action="/projects/<%= @project.id %>/threads/<%= @thread.id %>/messages/<%= reply.id %>" method="POST" style="display:inline;" onsubmit="return confirm('Delete this reply?');">
                              <input type="hidden" name="_method" value="DELETE">
                              <button type="submit" class="btn btn-ghost btn-sm" style="color:var(--danger);" title="Delete reply">
                              <i class="fa-solid fa-trash"></i>
                              </button>
                            </form>
                            
                          <% end %>
                            
                          </div>
                        </div>

                        <div style="color:var(--text-secondary); line-height:1.55; word-wrap:break-word; margin-top:0.35rem;">
                          <%= simple_format(h(reply.content)) %>
                        </div>
                      </div>
                    </div>
                  <% end %>
                </div>
              <% end %>
            </div>
          </div>
        <% end %>
      </div>
    <% else %>
      <div class="empty-content" style="text-align:center; padding:2rem;">
        <p class="empty-text" style="color:var(--text-muted); margin-bottom:0.5rem;">No messages yet</p>
        <p class="empty-hint" style="color:var(--text-muted); font-size:0.875rem;">Start the conversation!</p>
      </div>
    <% end %>
  </div>
</div>

<% if current_user.can_manage?(@project) %>
  <div class="content-card" id="new-message" style="margin-top:1.5rem;">
    <div class="card-header-section">
      <h2 class="card-title">Post a message</h2>
      <% if @thread.locked %>
        <span class="card-badge" style="background:rgba(239,68,68,0.1); color:#fca5a5; border:1px solid rgba(239,68,68,0.3);">Locked</span>
      <% end %>
    </div>

    <div class="card-content">
      <% if @thread.locked %>
        <p class="empty-text" style="color:var(--text-muted);">This thread is locked. No new messages can be posted.</p>
      <% else %>
        <form action="/projects/<%= @project.id %>/threads/<%= @thread.id %>/messages" method="POST" class="comment-form">
          <input type="hidden" name="message[parent_message_id]" id="parent_message_id" value="">
          <input type="hidden" name="message[reply_to_message_id]" id="reply_to_message_id" value="">

          <div id="reply-banner" style="display:none; margin-bottom:0.75rem; padding:0.5rem 0.75rem; border:1px solid var(--border); border-radius:var(--radius-lg); background:rgba(59,130,246,0.06); color:var(--text-secondary);">
            Replying to <span id="replying-to" style="font-weight:700;"></span>
            <button type="button" class="btn btn-ghost btn-sm" style="float:right;" onclick="clearReply()" title="Cancel reply">
              <i class="fa-solid fa-xmark"></i>
            </button>
          </div>

          <div class="comment-input-wrapper" style="display:flex; gap:0.75rem;">
            <div class="avatar-sm" style="flex-shrink:0;">
              <%= current_user.username[0].upcase %>
            </div>
            <div style="flex:1;">
              <textarea
                name="message[content]"
                id="message_content"
                placeholder="Write your message..."
                class="form-control"
                rows="4"
                required
                style="width:100%; resize:vertical; min-height:80px;"></textarea>
              <div style="display:flex; justify-content:flex-end; margin-top:0.75rem;">
                <button type="submit" class="btn btn-primary">Post Message</button>
              </div>
            </div>
          </div>
        </form>

        <script>
          function replyToMessage(replyToId, username, parentId) {
            const banner = document.getElementById('reply-banner');
            const replyingTo = document.getElementById('replying-to');
            const parentInput = document.getElementById('parent_message_id');
            const replyToInput = document.getElementById('reply_to_message_id');
            const textarea = document.getElementById('message_content');

            // parentId is optional: if replying to a parent message => parentId is undefined
            parentInput.value = parentId ? String(parentId) : String(replyToId);
            replyToInput.value = String(replyToId);
            replyingTo.textContent = '@' + username;
            banner.style.display = 'block';

            // Prefill with @username (requirement)
            const prefix = '@' + username + ' ';
            if (!textarea.value.startsWith(prefix)) {
              // remove any previous @mention at start, then add ours
              textarea.value = prefix + textarea.value.replace(/^@\w+\s+/, '');
            }

            textarea.focus();
            textarea.setSelectionRange(textarea.value.length, textarea.value.length);

            // Scroll to composer
            document.getElementById('new-message').scrollIntoView({ behavior: 'smooth', block: 'center' });
          }

          function clearReply() {
            document.getElementById('parent_message_id').value = '';
            document.getElementById('reply_to_message_id').value = '';
            document.getElementById('reply-banner').style.display = 'none';
            document.getElementById('replying-to').textContent = '';
          }
        </script>
      <% end %>
    </div>
  </div>
<% end %>
